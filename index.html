<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kennedy – My Logistics</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #1e3a8a, #0f172a, #881337);
      background-size: 400% 400%;
      animation: floatBG 20s ease infinite;
      overflow-x: hidden;
      color: #e2e8f0;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    @keyframes floatBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    header {
      background: linear-gradient(135deg, #facc15, #38bdf8);
      background-size: 200% 200%;
      animation: headerBG 5s ease infinite;
    }
    @keyframes headerBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .glow-hover:hover {
      text-shadow: 0 0 10px #facc15, 0 0 20px #38bdf8;
      transition: text-shadow 0.3s ease, transform 0.3s ease;
      transform: scale(1.03);
    }
    .icon-btn {
      width: 44px; height: 44px;
      border-radius: 9999px;
      background: linear-gradient(135deg, #facc15, #38bdf8);
      display: flex; align-items: center; justify-content: center;
      border: 2px solid #ffffff55;
      transition: transform .25s, box-shadow .25s, border .25s;
    }
    .icon-btn:hover { transform: scale(1.07); box-shadow: 0 0 18px #facc15, 0 0 28px #38bdf8; border-color: #facc15; }
    .card {
      background: rgba(31,41,55,0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 1rem;
      transition: transform .25s, box-shadow .25s;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 10px 26px rgba(0,0,0,.35); }
    .badge { border: 1px solid rgba(255,255,255,.18); }
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,.16), rgba(255,255,255,.08));
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    .modal-bg { background: rgba(0,0,0,.55); }
    /* small adjustments for mobile */
    @media (max-width: 640px) {
      header { padding-left: 1rem; padding-right: 1rem; }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Header -->
  <header class="flex justify-between items-center px-4 sm:px-6 py-4 fixed top-0 left-0 w-full z-50 shadow-md rounded-b-lg">
    <div class="flex items-center gap-2">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/truck.png" alt="Truck" class="h-8 w-8 glow-hover cursor-pointer"/>
      <h1 class="text-xl sm:text-2xl font-extrabold glow-hover cursor-pointer" onclick="location.href='index.html'">Kennedy</h1>
    </div>
    <nav class="flex items-center gap-2 sm:gap-3">
      <button title="Post Load" class="icon-btn" onclick="location.href='post-shipment.html'">
        <img src="https://img.icons8.com/ios-filled/22/000000/plus.png" alt="Add"/>
      </button>
      <button title="Home" class="icon-btn" onclick="location.href='index.html'">
        <img src="https://img.icons8.com/ios-filled/22/000000/home.png" alt="Home"/>
      </button>
      <button title="Profile" class="icon-btn" onclick="location.href='profile.html'">
        <img src="https://img.icons8.com/ios-filled/22/000000/user-male-circle.png" alt="Profile"/>
      </button>
    </nav>
  </header>

  <!-- Content -->
  <main class="flex-1 pt-24 pb-10 px-4 sm:px-6 max-w-6xl w-full mx-auto">
    <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 sm:gap-4 mb-4">
      <div>
        <h2 class="text-2xl sm:text-3xl font-extrabold">My Logistics</h2>
        <p class="text-slate-300 text-sm sm:text-base">History of loads you posted. Manage status or delete when booking limit is reached.</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white text-sm font-semibold">Refresh</button>
        <button id="exportBtn" class="px-3 py-2 rounded-lg bg-amber-500 hover:bg-amber-600 text-white text-sm font-semibold">Export CSV</button>
      </div>
    </div>

    <!-- Filters -->
    <section class="card p-3 sm:p-4 mb-5">
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-2">
        <input id="searchInput" class="col-span-2 md:col-span-2 px-3 py-2 rounded-lg bg-slate-700/70 focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="Search by city, name, vehicle…" />
        <select id="statusFilter" class="px-3 py-2 rounded-lg bg-slate-700/70 focus:outline-none focus:ring-2 focus:ring-sky-400">
          <option value="all">Status: All</option>
          <option value="true">Open (flag=true)</option>
          <option value="false">Closed (flag=false)</option>
        </select>
        <select id="demandFilter" class="px-3 py-2 rounded-lg bg-slate-700/70 focus:outline-none focus:ring-2 focus:ring-sky-400">
          <option value="all">Demanded: All</option>
          <option value="yes">Demanded</option>
          <option value="no">Not Demanded</option>
        </select>
        <input id="fromDate" type="date" class="px-3 py-2 rounded-lg bg-slate-700/70 focus:outline-none focus:ring-2 focus:ring-sky-400"/>
        <input id="toDate" type="date" class="px-3 py-2 rounded-lg bg-slate-700/70 focus:outline-none focus:ring-2 focus:ring-sky-400"/>
      </div>
    </section>

    <!-- Counters -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
      <div class="card p-4">
        <div class="text-sm text-slate-300">Total</div>
        <div id="statTotal" class="text-2xl font-extrabold">0</div>
      </div>
      <div class="card p-4">
        <div class="text-sm text-slate-300">Open (flag=true)</div>
        <div id="statOpen" class="text-2xl font-extrabold">0</div>
      </div>
      <div class="card p-4">
        <div class="text-sm text-slate-300">Demanded</div>
        <div id="statDemanded" class="text-2xl font-extrabold">0</div>
      </div>
      <div class="card p-4">
        <div class="text-sm text-slate-300">Closed</div>
        <div id="statClosed" class="text-2xl font-extrabold">0</div>
      </div>
    </section>

    <!-- Results toolbar -->
    <section class="flex items-center justify-between gap-2 mb-3">
      <div class="text-slate-300 text-sm"><span id="countShown">0</span> shown</div>
      <select id="sortSelect" class="px-3 py-2 rounded-lg bg-slate-700/70 focus:outline-none focus:ring-2 focus:ring-amber-400 text-sm">
        <option value="date_desc">Sort: Date ⬇</option>
        <option value="date_asc">Sort: Date ⬆</option>
        <option value="price_desc">Sort: Price ⬇</option>
        <option value="price_asc">Sort: Price ⬆</option>
      </select>
    </section>

    <!-- List -->
    <section id="listContainer" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
      <!-- Skeletons initially -->
      <div class="card p-4 skeleton h-40 rounded-xl"></div>
      <div class="card p-4 skeleton h-40 rounded-xl"></div>
      <div class="card p-4 skeleton h-40 rounded-xl"></div>
    </section>

    <!-- Pagination -->
    <div class="flex justify-center mt-6">
      <button id="prevPage" class="px-3 py-2 rounded-l-lg bg-slate-700/70 hover:bg-slate-700 disabled:opacity-40">Prev</button>
      <span id="pageInfo" class="px-4 py-2 bg-slate-800/70">1 / 1</span>
      <button id="nextPage" class="px-3 py-2 rounded-r-lg bg-slate-700/70 hover:bg-slate-700 disabled:opacity-40">Next</button>
    </div>
  </main>

  <!-- Confirm Modal -->
  <div id="confirmModal" class="hidden fixed inset-0 z-[60] modal-bg flex items-center justify-center p-4">
    <div class="card w-full max-w-md p-5">
      <h3 id="confirmTitle" class="text-xl font-bold mb-2">Confirm</h3>
      <p id="confirmMessage" class="text-slate-300 mb-4">Are you sure?</p>
      <div class="flex justify-end gap-2">
        <button id="confirmCancel" class="px-3 py-2 rounded-lg bg-slate-600 hover:bg-slate-500">Cancel</button>
        <button id="confirmOk" class="px-3 py-2 rounded-lg bg-red-600 hover:bg-red-700">Yes</button>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden px-4 py-2 rounded-lg bg-black/70 text-white text-sm z-[70]"></div>

  <script>
    // ======== CONFIG ========
    const API_BASE = 'http://localhost:8080/api/logistics';
    // Define your endpoints (adjust if your backend differs)
    const ENDPOINTS = {
      MY_LIST: (email) => `${API_BASE}/owner?email=${encodeURIComponent(email)}`,
      CLOSE_STATUS: (id) => `${API_BASE}/${id}/status`,           // PUT { status:false }
      DELETE: (id) => `${API_BASE}/${id}`                         // DELETE
    };

    // ======== AUTH CONTEXT ========
    // Expect owner email to be set at login. Fallback: prompt once.
    let ownerEmail = localStorage.getItem('ownerEmail');
    if (!ownerEmail) {
      ownerEmail = prompt('Enter your owner email (temp for demo):') || '';
      localStorage.setItem('ownerEmail', ownerEmail);
    }

    // ======== STATE ========
    let allItems = [];      // raw from backend
    let viewItems = [];     // filtered/sorted
    let currentPage = 1;
    const pageSize = 9;

    // ======== UI ELEMENTS ========
    const listContainer = document.getElementById('listContainer');
    const statTotal = document.getElementById('statTotal');
    const statOpen = document.getElementById('statOpen');
    const statClosed = document.getElementById('statClosed');
    const statDemanded = document.getElementById('statDemanded');
    const countShown = document.getElementById('countShown');
    const pageInfo = document.getElementById('pageInfo');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');

    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const demandFilter = document.getElementById('demandFilter');
    const fromDate = document.getElementById('fromDate');
    const toDate = document.getElementById('toDate');
    const sortSelect = document.getElementById('sortSelect');

    const refreshBtn = document.getElementById('refreshBtn');
    const exportBtn = document.getElementById('exportBtn');

    const confirmModal = document.getElementById('confirmModal');
    const confirmTitle = document.getElementById('confirmTitle');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmCancel = document.getElementById('confirmCancel');
    const confirmOk = document.getElementById('confirmOk');

    const toast = document.getElementById('toast');

    // ======== HELPERS ========
    const showToast = (msg, ms=1800) => {
      toast.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(()=> toast.classList.add('hidden'), ms);
    };

    const money = (n) => isFinite(n) ? '₹ ' + Number(n).toLocaleString('en-IN') : '—';

    const parseDate = (d) => d ? new Date(d) : null;

    const inRange = (date, from, to) => {
      const t = +date;
      if (from && t < +from) return false;
      if (to && t > (+to + 24*60*60*1000 - 1)) return false; // inclusive
      return true;
    };

    const demandedText = (item) => {
      // Support either "demanded" boolean or "demandCount" number from backend
      const count = typeof item.demandCount === 'number' ? item.demandCount : (item.demanded ? 1 : 0);
      return count > 0 ? `Yes (${count})` : 'No';
    };

    const statusPill = (flag) => {
      return flag
        ? '<span class="badge px-2 py-1 rounded-full text-xs bg-emerald-600/30 text-emerald-200">Open</span>'
        : '<span class="badge px-2 py-1 rounded-full text-xs bg-rose-600/30 text-rose-200">Closed</span>';
    };

    const demandPill = (item) => {
      const has = (item.demandCount && item.demandCount>0) || item.demanded === true;
      return has
        ? '<span class="badge px-2 py-1 rounded-full text-xs bg-amber-600/30 text-amber-200">Demanded</span>'
        : '<span class="badge px-2 py-1 rounded-full text-xs bg-slate-600/30 text-slate-200">Not Demanded</span>';
    };

    // ======== FETCH ========
    async function fetchMyLogistics() {
      listContainer.innerHTML = `
        <div class="card p-4 skeleton h-40 rounded-xl"></div>
        <div class="card p-4 skeleton h-40 rounded-xl"></div>
        <div class="card p-4 skeleton h-40 rounded-xl"></div>
      `;
      try {
        const res = await fetch(ENDPOINTS.MY_LIST(ownerEmail), { headers: { 'Accept': 'application/json' }});
        if (!res.ok) throw new Error(await res.text() || 'Failed to load');
        const data = await res.json();
        // Normalize fields a bit for safety
        allItems = (Array.isArray(data) ? data : []).map(x => ({
          id: x.id ?? x._id ?? x.logisticsId,
          logisticsName: x.logisticsName ?? x.name ?? 'Logistics',
          pickupCity: x.pickupCity ?? (x.pickup ? x.pickup.split(',')[0] : '') ?? '',
          pickupState: x.pickupState ?? (x.pickup ? (x.pickup.split(',')[1] || '').trim() : '') ?? '',
          dropCity: x.dropCity ?? (x.dropLocation ? x.dropLocation.split(',')[0] : '') ?? '',
          dropState: x.dropState ?? (x.dropLocation ? (x.dropLocation.split(',')[1] || '').trim() : '') ?? '',
          date: x.date,
          createdAt: x.createdAt ?? x.created_at ?? x.date, // fallback
          tonnage: x.tonnage ?? x.weight,
          vehicleType: x.vehicleType,
          price: x.price,
          priority: x.priority,
          status: (typeof x.status === 'boolean') ? x.status : (x.flag ?? true), // flag=true means open
          demanded: x.demanded,
          demandCount: x.demandCount
        }));
        currentPage = 1;
        applyFiltersAndRender();
      } catch (err) {
        console.error(err);
        listContainer.innerHTML = `
          <div class="card p-6 sm:p-8 text-center col-span-full">
            <div class="text-red-300 font-semibold mb-2">Failed to load logistics.</div>
            <div class="text-slate-300 mb-4">${String(err.message || err)}</div>
            <button class="px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600" onclick="fetchMyLogistics()">Retry</button>
          </div>`;
      }
    }

    // ======== FILTER + SORT + PAGINATE ========
    function applyFiltersAndRender() {
      const q = (searchInput.value || '').trim().toLowerCase();
      const statusVal = statusFilter.value; // all | true | false
      const demandVal = demandFilter.value; // all | yes | no
      const fd = fromDate.value ? new Date(fromDate.value) : null;
      const td = toDate.value ? new Date(toDate.value) : null;

      viewItems = allItems.filter(item => {
        // status filter
        if (statusVal !== 'all') {
          const want = statusVal === 'true';
          if (item.status !== want) return false;
        }
        // demand filter
        if (demandVal !== 'all') {
          const hasDemand = (item.demandCount && item.demandCount>0) || item.demanded === true;
          if (demandVal === 'yes' && !hasDemand) return false;
          if (demandVal === 'no' && hasDemand) return false;
        }
        // date range (by preferred date if present, else createdAt)
        const d = parseDate(item.date) || parseDate(item.createdAt);
        if (fd || td) {
          if (!d || !inRange(d, fd, td)) return false;
        }
        // search
        if (q) {
          const bag = [
            item.logisticsName, item.pickupCity, item.pickupState,
            item.dropCity, item.dropState, item.vehicleType, item.priority
          ].join(' ').toLowerCase();
          if (!bag.includes(q)) return false;
        }
        return true;
      });

      // sort
      const mode = sortSelect.value;
      viewItems.sort((a,b) => {
        const da = +parseDate(a.date || a.createdAt) || 0;
        const db = +parseDate(b.date || b.createdAt) || 0;
        if (mode === 'date_desc') return db - da;
        if (mode === 'date_asc') return da - db;
        if (mode === 'price_desc') return (b.price||0) - (a.price||0);
        if (mode === 'price_asc') return (a.price||0) - (b.price||0);
        return 0;
      });

      // counters
      statTotal.textContent = allItems.length;
      statOpen.textContent = allItems.filter(x => x.status === true).length;
      statClosed.textContent = allItems.filter(x => x.status === false).length;
      statDemanded.textContent = allItems.filter(x => (x.demandCount && x.demandCount>0) || x.demanded === true).length;

      renderPage();
    }

    function renderPage() {
      const totalPages = Math.max(1, Math.ceil(viewItems.length / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage-1)*pageSize;
      const pageItems = viewItems.slice(start, start+pageSize);
      countShown.textContent = pageItems.length;

      pageInfo.textContent = `${currentPage} / ${totalPages}`;
      prevPage.disabled = currentPage === 1;
      nextPage.disabled = currentPage === totalPages;

      if (pageItems.length === 0) {
        listContainer.innerHTML = `
          <div class="card p-6 sm:p-8 text-center col-span-full">
            <div class="text-lg font-semibold">No results</div>
            <div class="text-slate-300">Try changing filters or date range.</div>
          </div>`;
        return;
      }

      listContainer.innerHTML = pageItems.map(item => cardTemplate(item)).join('');
    }

    function cardTemplate(item) {
      const dateStr = item.date ? new Date(item.date).toLocaleDateString() : '—';
      const perTon = money(item.price);
      const total = (isFinite(item.price) && isFinite(item.tonnage)) ? money(item.price * item.tonnage) : '—';

      return `
        <article class="card p-4 flex flex-col">
          <div class="flex items-start justify-between gap-2">
            <div>
              <h3 class="text-lg font-bold">${escapeHtml(item.logisticsName)}</h3>
              <div class="text-sm text-slate-300">${escapeHtml(item.pickupCity)}, ${escapeHtml(item.pickupState)} ➜ ${escapeHtml(item.dropCity)}, ${escapeHtml(item.dropState)}</div>
            </div>
            <div class="flex flex-wrap gap-2">
              ${statusPill(item.status)}
              ${demandPill(item)}
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2 text-sm mt-3">
            <div class="bg-slate-800/60 rounded-lg p-2">
              <div class="text-slate-400">Date</div>
              <div class="font-semibold">${dateStr}</div>
            </div>
            <div class="bg-slate-800/60 rounded-lg p-2">
              <div class="text-slate-400">Vehicle</div>
              <div class="font-semibold">${escapeHtml(item.vehicleType || '—')}</div>
            </div>
            <div class="bg-slate-800/60 rounded-lg p-2">
              <div class="text-slate-400">Tonnage</div>
              <div class="font-semibold">${item.tonnage ?? '—'} t</div>
            </div>
            <div class="bg-slate-800/60 rounded-lg p-2">
              <div class="text-slate-400">Price / ton</div>
              <div class="font-semibold">${perTon}</div>
            </div>
            <div class="bg-slate-800/60 rounded-lg p-2 col-span-2">
              <div class="text-slate-400">Estimated Total</div>
              <div class="font-semibold">${total}</div>
            </div>
          </div>

          <div class="mt-4 flex flex-wrap gap-2">
            ${item.status
              ? `<button class="px-3 py-2 rounded-lg bg-amber-500 hover:bg-amber-600 text-sm font-semibold"
                         onclick="confirmClose('${encodeURIComponent(item.id)}')">Close Booking</button>`
              : `<button class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-sm font-semibold"
                         onclick="reopenInfo()">Closed</button>`
            }
            <button class="px-3 py-2 rounded-lg bg-rose-600 hover:bg-rose-700 text-sm font-semibold"
                    onclick="confirmDelete('${encodeURIComponent(item.id)}')">Delete</button>
            <button class="ml-auto px-3 py-2 rounded-lg bg-sky-600 hover:bg-sky-700 text-sm font-semibold"
                    onclick="viewDetails('${encodeURIComponent(item.id)}')">Details</button>
          </div>
        </article>
      `;
    }

    function escapeHtml(s) {
      return String(s ?? '').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    // ======== ACTIONS ========
    function confirmClose(id) {
      openConfirm('Close Booking', 'This will set status=false (not visible to users). Continue?', async () => {
        try {
          // optimistic UI
          const idx = allItems.findIndex(x => String(x.id) === decodeURIComponent(id));
          if (idx >= 0) { allItems[idx].status = false; }
          applyFiltersAndRender();

          const res = await fetch(ENDPOINTS.CLOSE_STATUS(decodeURIComponent(id)), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: false })
          });
          if (!res.ok) throw new Error(await res.text() || 'Failed to update status');
          showToast('Booking closed (status=false).');
        } catch (e) {
          showToast('Error closing booking.');
          console.error(e);
          // reload from backend to recover
          fetchMyLogistics();
        }
      });
    }

    function reopenInfo() {
      showToast('Closed items are hidden from users. To reopen, implement PUT {status:true} in backend.');
    }

    function confirmDelete(id) {
      openConfirm('Delete Logistics', 'Delete this logistics permanently? (We also recommend keeping status=false in backend.)', async () => {
        try {
          // optimistic UI
          const idDec = decodeURIComponent(id);
          const keep = allItems.filter(x => String(x.id) !== idDec);
          allItems = keep;
          applyFiltersAndRender();

          const res = await fetch(ENDPOINTS.DELETE(idDec), { method: 'DELETE' });
          if (!res.ok) throw new Error(await res.text() || 'Failed to delete');
          showToast('Deleted successfully.');
        } catch (e) {
          showToast('Error deleting item.');
          console.error(e);
          fetchMyLogistics();
        }
      });
    }

    function viewDetails(id) {
      // Route to a details page (optional)
      // Pass id via query param
      window.location.href = `logistics-details.html?id=${encodeURIComponent(id)}`;
    }

    // ======== CONFIRM MODAL ========
    let confirmHandler = null;
    function openConfirm(title, msg, onOk) {
      confirmTitle.textContent = title;
      confirmMessage.textContent = msg;
      confirmModal.classList.remove('hidden');
      confirmHandler = onOk;
    }
    confirmCancel.onclick = () => { confirmModal.classList.add('hidden'); confirmHandler = null; };
    confirmOk.onclick = async () => {
      confirmModal.classList.add('hidden');
      if (typeof confirmHandler === 'function') {
        const h = confirmHandler; confirmHandler = null;
        await h();
      }
    }
    confirmModal.addEventListener('click', (e) => {
      if (e.target === confirmModal) { confirmCancel.click(); }
    });

    // ======== EVENTS ========
    [searchInput, statusFilter, demandFilter, fromDate, toDate, sortSelect].forEach(el => {
      el.addEventListener('input', () => { currentPage = 1; applyFiltersAndRender(); });
      el.addEventListener('change', () => { currentPage = 1; applyFiltersAndRender(); });
    });
    prevPage.onclick = () => { currentPage = Math.max(1, currentPage - 1); renderPage(); };
    nextPage.onclick = () => {
      const totalPages = Math.max(1, Math.ceil(viewItems.length / pageSize));
      currentPage = Math.min(totalPages, currentPage + 1);
      renderPage();
    };

    refreshBtn.onclick = fetchMyLogistics;

    exportBtn.onclick = () => {
      const rows = [
        ['ID','Name','Pickup','Drop','Date','Tonnage','Vehicle','PricePerTon','Total','Priority','StatusFlag','DemandCount'],
        ...viewItems.map(x => [
          x.id,
          x.logisticsName,
          `${x.pickupCity}, ${x.pickupState}`,
          `${x.dropCity}, ${x.dropState}`,
          x.date || '',
          x.tonnage ?? '',
          x.vehicleType ?? '',
          x.price ?? '',
          (isFinite(x.price) && isFinite(x.tonnage)) ? (x.price * x.tonnage) : '',
          x.priority ?? '',
          x.status === true ? 'true' : 'false',
          typeof x.demandCount === 'number' ? x.demandCount : (x.demanded ? 1 : 0)
        ])
      ];
      const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'my-logistics.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    // ======== INIT ========
    fetchMyLogistics();
  </script>
</body>
</html>

